# 日志方案与错误码对照表

本文档用于说明 Mylo 应用当前的日志体系设计、日志落点以及错误码的使用规范，方便后续开发与问题排查。

> 说明：本表覆盖当前主要功能模块中已经使用的错误码，后续新增模块或场景时，请在使用新的日志 code 的同时更新本文件。

---

## 1. 整体日志架构

- 日志主要由主进程统一收集写入文件，文件路径：
  - macOS：`~/Library/Application Support/Mylo/electron.log`
  - 开发环境：userData 目录会自动加 `-dev` 后缀，例如 `Mylo-dev/electron.log`
- 主进程在启动时调用 `initLogger()`（见 `src/main/logger.ts`）：
  - 接管 `console.log/info/warn/error`，统一写入 `electron.log`
  - 监听：
    - `process.on('uncaughtException')`
    - `process.on('unhandledRejection')`
    - `app.on('render-process-gone')`
    - `app.on('child-process-gone')`
  - 因此未捕获异常、渲染进程崩溃等高危问题会自动落日志。

---

## 2. 主进程日志封装（logger）

文件：`src/main/logger.ts`

- 核心类型：
  - `type LogContext = Record<string, unknown>`
- 对外提供的日志接口：
  - `logInfo(code: string, message: string, context?: LogContext)`
  - `logWarn(code: string, message: string, context?: LogContext)`
  - `logError(code: string, message: string, error?: unknown, context?: LogContext)`
- 使用约定：
  - `code`：**必填，短而稳定的错误/事件标识**，用于在日志文件中快速搜索。
  - `message`：简短的中文/英文描述，用于人类快速阅读。
  - `context`：仅包含非敏感信息（例如 `format`、`directory`、`mergeStrategy` 等）。
  - `error`：若有异常对象，尽量直接传入 `Error` 实例，保持堆栈。
- 格式示例（概念上）：

```text
[2024-03-01 12:00:00] [ERROR] AUTO_EXPORT_FAILED 自动导出失败 {"directory":"/Users/.../backup","format":"json"} Error: ...
```

> 推荐：主进程代码**不再直接使用 `console.info/console.error` 记录业务日志**，统一通过 `logInfo/logWarn/logError`，便于后续按 code 搜索。

---

## 3. 渲染进程错误上报方案

### 3.1 IPC 入口与 preload 暴露

- 文件：`src/main/ipc/logging.ts`
  - 注册 IPC：`ipcMain.handle('renderer-report-error', ...)`
  - 接收 `RendererLogPayload`：
    - `code?: string`
    - `message: string`
    - `context?: LogContext`
    - `stack?: string`
    - `source?: string`（默认 `'renderer'`）
  - 内部通过：

```ts
logError(code || 'RENDERER_ERROR', message || 'renderer error', undefined, mergedContext);
```

- 文件：`src/main/preload.ts`
  - 在 `ElectronAPI` 中新增：

```ts
reportError?: (payload: {
  code?: string;
  message: string;
  context?: Record<string, unknown>;
  stack?: string;
  source?: string;
}) => Promise<void>;
```

  - 对应实现：

```ts
reportError: (payload) => ipcRenderer.invoke('renderer-report-error', payload),
```

### 3.2 渲染端统一封装

- 文件：`src/renderer/utils/logging.ts`
  - 导出函数：

```ts
export function reportError(
  code: string,
  message: string,
  error?: unknown,
  context?: Record<string, unknown>
): void
```

  - 行为：
    - 提取 `error` 的 `stack` 或字符串描述。
    - 开发环境保留控制台输出（`console.error(message, error, context)`）。
    - 通过 `window.electronAPI.reportError` 上报给主进程，由主进程写入 `electron.log`。

### 3.3 渲染层使用规范

- UI 代码中出现异常时，推荐模式：

```ts
try {
  // 业务逻辑
} catch (error) {
  message.error('对用户友好的错误提示');
  reportError('SOME_CODE', '简短的错误说明', error, { optionalContext });
}
```

- 注意：
  - `message.error` 负责用户感知。
  - `reportError` 负责排查与线下分析。
  - 不在日志中写入密码等敏感字段。

---

## 4. 关键模块与日志落点

本节列出目前已接入统一日志方案的主要模块，按功能域划分。

### 4.1 应用启动与主窗口（主进程）

- 文件：`src/main/main.ts`
  - 启动与初始化：
    - `APP_START`：应用启动入口。
    - `APP_READY`：Electron `app.whenReady()` 完成。
    - `APP_INIT_FAILED`：初始化过程中出现未处理异常，应用将退出。
  - 数据库与 logger：
    - `DB_INIT_SUCCESS`：数据库初始化成功，context 带 `logFilePath`。
    - `DB_INIT_FAILED` / `DB_INIT_ERROR`：见下一小节。
  - 窗口生命周期：
    - `MAIN_WINDOW_CREATED`：主窗口创建完成。
    - `MAIN_WINDOW_READY`：主窗口 `ready-to-show`。
    - `MAIN_WINDOW_HIDDEN`：macOS 下点击关闭按钮仅隐藏窗口。
    - `MAIN_WINDOW_CLOSED`：主窗口真正关闭。
  - 其他：
    - `APP_INIT_USERDATA_FAILED`：设置 `userData` 开发路径失败。
    - `E2E_EXPORT_IMPORT_DONE`：E2E 导入/导出自检成功。
    - `E2E_EXPORT_IMPORT_FAILED`：E2E 自检失败。
    - `OPEN_EXTERNAL_FAILED`：外部链接打开失败，context 带 `url`。

### 4.2 数据库初始化（主进程）

- 文件：`src/main/database/DatabaseService.ts`
  - 构造阶段：
    - `DB_INIT_FAILED`：`initializeDatabase()` 调用失败。
  - 初始化细节：
    - `DB_INIT_ERROR`：数据库文件打开 / PRAGMA / 建表或服务初始化阶段抛出异常。

### 4.3 自动导出与定时任务（主进程）

- 文件：`src/main/services/AutoExportService.ts`
  - 配置调度：
    - `AUTO_EXPORT_SCHEDULED`：
      - 自动导出计划已安排。
      - context 包含：`enabled`、`frequency`、`directory`、`format`、`hasPassword`、`lastTime`、`delayMs`。
  - 执行过程：
    - `AUTO_EXPORT_START`：
      - 自动导出任务开始执行。
      - context：`format`、`frequency`。
    - `AUTO_EXPORT_SUCCESS`：
      - 自动导出成功。
      - context：`filePath`。
    - `AUTO_EXPORT_FAILED`：
      - 自动导出任务失败。
      - context：`directory`、`format`。

### 4.4 设置与用户偏好（IPC + 渲染）

- 主进程 IPC：`src/main/ipc/settings.ts`
  - `SETTINGS_CHANGE_CALLBACK_FAILED`：设置变更回调失败。
  - `IPC_SET_USER_SETTING_FAILED`：`set-user-setting` 调用失败。
  - `IPC_UPDATE_USER_SETTING_FAILED`：`update-user-setting` 调用失败。
  - `IPC_DELETE_USER_SETTING_FAILED`：`delete-user-setting` 调用失败。
  - `IPC_RESET_SETTING_TO_DEFAULT_FAILED`：重置单个设置到默认值失败。
  - `IPC_RESET_ALL_SETTINGS_TO_DEFAULT_FAILED`：重置所有设置到默认值失败。
  - `IPC_IMPORT_SETTINGS_FAILED`：导入设置失败。
  - `IPC_EXPORT_SETTINGS_FAILED`：导出设置失败。

- 渲染层用户设置页面：`src/renderer/components/UserSettings.tsx`
  - `SETTINGS_LOAD_FAILED`：用户设置页面初始化加载失败。
  - `SETTINGS_SAVE_FAILED`：保存设置失败。
  - `SETTINGS_RESET_FAILED`：重置为默认设置失败。
  - `SETTINGS_QUICK_EXPORT_FAILED`：设置页的“快速导出”失败。
  - `SETTINGS_PICK_EXPORT_DIRECTORY_FAILED`：选择自动导出目录失败。
  - `SETTINGS_CHECK_INTEGRITY_FAILED`：数据完整性检查失败。
  - `SETTINGS_REPAIR_INTEGRITY_FAILED`：数据完整性修复失败。
  - `SETTINGS_MASTER_PASSWORD_OPERATION_FAILED`：主密码设置/更新/关闭操作失败。

### 4.5 备份 / 导入导出（IPC + 渲染）

- 主进程 IPC：`src/main/ipc/backup.ts`
  - `IPC_EXPORT_DATA_FAILED`：内存导出数据（返回字节数组）失败。
  - `IPC_EXPORT_DATA_TO_FILE_FAILED`：导出到指定文件路径失败（包括写文件异常）。
  - `IPC_PICK_EXPORT_PATH_FAILED`：保存路径对话框打开或交互失败。
  - `IPC_IMPORT_DATA_FAILED`：导入数据失败，context 包含 `mergeStrategy` / `validateIntegrity` / `dryRun`。
  - `IPC_CHECK_DATA_INTEGRITY_FAILED`：一致性检查失败。
  - `IPC_REPAIR_DATA_INTEGRITY_FAILED`：一致性修复失败。
  - `IPC_PICK_EXPORT_DIRECTORY_FAILED`：选择导出目录对话框失败。

- 渲染层导入导出弹窗：`src/renderer/components/ImportExportModal.tsx`
  - `EXPORT_MODAL_EXPORT_FAILED`：弹窗中“导出”流程失败。
  - `EXPORT_MODAL_IMPORT_FAILED`：弹窗中“导入”流程失败。

### 4.6 密码 / 分组 / 历史（渲染）

- Hooks：`src/renderer/hooks/usePasswords.ts`
  - `PASSWORDS_LOAD_FAILED`：按分组加载密码失败（context 包含 `groupId`）。
  - `PASSWORDS_LOAD_RECENT_FAILED`：加载最近使用密码失败。
  - `PASSWORD_HISTORY_LOAD_FAILED`：加载某条密码的历史记录失败（context 包含 `passwordId`）。

- Hooks：`src/renderer/hooks/useGroups.ts`
  - `GROUPS_LOAD_FAILED`：加载密码分组列表与树失败。

- 密码详情：`src/renderer/components/PasswordDetailModal.tsx`
  - `PASSWORD_DETAIL_SAVE_FAILED`：密码详情保存失败。

- 密码生成器：`src/renderer/components/PasswordGenerator.tsx`
  - `PASSWORD_GENERATE_FAILED`：调用主进程密码生成失败（context 包含生成参数）。

- 主界面密码/分组相关：`src/renderer/App.tsx`
  - `APP_DELETE_PASSWORD_FAILED`：删除密码失败（context 包含 `passwordId`）。
  - `APP_SUBMIT_PASSWORD_FAILED`：新增/编辑密码表单提交失败（context 包含 `mode` 和 `hasEditingPassword`）。
  - `APP_DELETE_GROUP_FAILED`：删除分组失败（context 包含 `groupId`）。
  - `APP_SUBMIT_GROUP_FAILED`：新增/编辑分组表单失败（context 包含是否为编辑模式）。

### 4.7 安全与主密码状态（渲染）

- 文件：`src/renderer/App.tsx`
  - `APP_LOAD_SECURITY_STATE_FAILED`：应用启动时加载安全状态失败。
  - `APP_REFRESH_SECURITY_STATE_FAILED`：关闭设置弹窗后刷新安全状态失败。

---

## 5. 渲染层错误码快速查找方式

所有通过 `reportError` 上报的错误码可以在渲染层代码中按以下方式搜索：

- 命令示例：

```bash
grep -R "reportError(" -n src/renderer
```

常见筛选场景：

- 密码相关问题：搜索 `PASSWORD_` 前缀。
- 分组相关问题：搜索 `GROUPS_` 或 `APP_DELETE_GROUP_FAILED`。
- 设置与安全相关：搜索 `SETTINGS_` 或 `APP_LOAD_SECURITY_STATE_FAILED`。
- 导入导出问题：搜索 `EXPORT_MODAL_` 与 IPC 侧的 `IPC_EXPORT_` / `IPC_IMPORT_`。

---

## 6. 新增错误码与日志时的约定

1. **命名规范**
   - 采用大写下划线风格：
     - 领域前缀 + 场景，如：
       - `APP_*`：应用级事件。
       - `DB_*`：数据库相关。
       - `AUTO_EXPORT_*`：自动导出。
       - `IPC_*`：主进程 IPC 处理。
       - `SETTINGS_*`：用户设置。
       - `PASSWORD_*` / `GROUPS_*`：密码/分组。
   - 确保语义清晰、稳定。

2. **敏感信息**
   - 禁止在日志中记录：
     - 用户密码、加密密钥、完整导出数据内容。
   - 允许记录的 context 示例：
     - `format`、`frequency`、`directory`（路径注意仅用于诊断）。

3. **文档更新**
   - 若新增了新的错误码（尤其是主流程 / 关键模块），请在本文件中新增对应条目：
     - 记录：错误码、所在模块、触发条件、主要 context 字段。

通过以上约定，任意“密码/分组/便签/设置/导入导出”相关的问题，都可以在 `electron.log` 中通过错误码快速定位到具体模块与上下文，减少现场排查成本。  

