# 个人密码管理App数据模型设计

## 1. 数据模型概述

### 1.1 设计原则
- **安全性**：所有敏感数据加密存储
- **性能**：合理的数据结构和索引设计
- **扩展性**：支持未来功能扩展
- **一致性**：数据完整性约束
- **本地化**：完全本地存储，无服务器依赖

### 1.2 技术选型
- **数据库**：SQLite 3
- **加密算法**：AES-256-CBC
- **密钥派生**：自定义密钥派生算法
- **ORM**：原生SQL + better-sqlite3

### 1.3 数据存储架构
```
┌─────────────────────────────────────────┐
│              Application Layer          │
├─────────────────────────────────────────┤
│            Database Service             │
│         (Encryption + CRUD)             │
├─────────────────────────────────────────┤
│              SQLite Database            │
│         (passwords.db)                  │
└─────────────────────────────────────────┘
```

## 2. 核心数据模型

### 2.1 用户设置模型 (UserSettings)

#### 数据表结构
```sql
CREATE TABLE user_settings (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    key TEXT NOT NULL UNIQUE,
    value TEXT NOT NULL,
    type TEXT NOT NULL DEFAULT 'string',
    category TEXT NOT NULL DEFAULT 'general',
    description TEXT,
    created_at TEXT NOT NULL,
    updated_at TEXT NOT NULL
);
```

#### 接口定义
```typescript
interface UserSetting {
    id?: number;           // 设置ID（主键）
    key: string;           // 设置键名（必填，唯一）
    value: string;         // 设置值（必填）
    type?: 'string' | 'number' | 'boolean' | 'json'; // 数据类型
    category?: string;     // 设置分类（必填）
    description?: string;  // 设置描述
    created_at?: string;   // 创建时间（ISO 8601格式）
    updated_at?: string;   // 更新时间（ISO 8601格式）
}

interface UserSettingsCategory {
    category: string;      // 分类名称
    description: string;   // 分类描述
    settings: UserSetting[]; // 该分类下的设置项
}
```

#### 预定义设置项
```typescript
const DEFAULT_SETTINGS = {
    // 安全设置
    'security.auto_lock_timeout': {
        value: '300',
        type: 'number',
        category: 'security',
        description: '自动锁定时间（秒）'
    },
    'security.password_generator_length': {
        value: '16',
        type: 'number',
        category: 'security',
        description: '密码生成器默认长度'
    },
    'security.password_generator_include_symbols': {
        value: 'true',
        type: 'boolean',
        category: 'security',
        description: '密码生成器包含特殊字符'
    },
    'security.clipboard_clear_timeout': {
        value: '30',
        type: 'number',
        category: 'security',
        description: '剪贴板自动清除时间（秒）'
    },
    
    // 界面设置
    'ui.theme': {
        value: 'light',
        type: 'string',
        category: 'ui',
        description: '界面主题（light/dark/auto）'
    },
    'ui.language': {
        value: 'zh-CN',
        type: 'string',
        category: 'ui',
        description: '界面语言'
    },
    'ui.default_group_color': {
        value: 'blue',
        type: 'string',
        category: 'ui',
        description: '默认分组颜色'
    },
    'ui.show_password_strength': {
        value: 'true',
        type: 'boolean',
        category: 'ui',
        description: '显示密码强度指示器'
    },
    
    // 备份设置
    'backup.auto_backup_enabled': {
        value: 'false',
        type: 'boolean',
        category: 'backup',
        description: '启用自动备份'
    },
    'backup.auto_backup_interval': {
        value: '7',
        type: 'number',
        category: 'backup',
        description: '自动备份间隔（天）'
    },
    'backup.backup_location': {
        value: '',
        type: 'string',
        category: 'backup',
        description: '备份文件保存位置'
    },
    'backup.max_backup_count': {
        value: '10',
        type: 'number',
        category: 'backup',
        description: '最大备份数量'
    },
    
    // 通知设置
    'notification.password_expiry_warning': {
        value: 'true',
        type: 'boolean',
        category: 'notification',
        description: '密码过期提醒'
    },
    'notification.weak_password_warning': {
        value: 'true',
        type: 'boolean',
        category: 'notification',
        description: '弱密码警告'
    },
    'notification.duplicate_password_warning': {
        value: 'true',
        type: 'boolean',
        category: 'notification',
        description: '重复密码警告'
    },
    
    // 性能设置
    'performance.search_result_limit': {
        value: '50',
        type: 'number',
        category: 'performance',
        description: '搜索结果最大数量'
    },
    'performance.history_retention_days': {
        value: '365',
        type: 'number',
        category: 'performance',
        description: '历史记录保留天数'
    },
    
    // 高级设置
    'advanced.export_format': {
        value: 'json',
        type: 'string',
        category: 'advanced',
        description: '默认导出格式'
    },
    'advanced.compression_level': {
        value: '6',
        type: 'number',
        category: 'advanced',
        description: '压缩级别（0-9）'
    }
};
```

#### 业务规则
- 设置键名必须唯一
- 支持字符串、数字、布尔值和JSON类型
- 设置按分类组织，便于管理
- 所有设置都有默认值
- 支持设置的导入导出
- 设置变更时自动更新时间戳
- 敏感设置（如密码）需要额外加密存储

#### 数据示例
```json
{
    "id": 1,
    "key": "security.auto_lock_timeout",
    "value": "300",
    "type": "number",
    "category": "security",
    "description": "自动锁定时间（秒）",
    "created_at": "2024-01-01T10:00:00.000Z",
    "updated_at": "2024-01-15T15:30:00.000Z"
}
```

### 2.2 分组模型 (Group)

#### 数据表结构
```sql
CREATE TABLE groups (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name TEXT NOT NULL,
    parent_id INTEGER,
    color TEXT DEFAULT 'blue',
    created_at TEXT NOT NULL,
    updated_at TEXT NOT NULL
);
```

#### 接口定义
```typescript
interface Group {
    id?: number;           // 分组ID（主键）
    name: string;          // 分组名称（必填，唯一）
    parent_id?: number;    // 父分组ID（支持树形结构）
    color?: string;        // 分组颜色标识
    created_at?: string;   // 创建时间（ISO 8601格式）
    updated_at?: string;   // 更新时间（ISO 8601格式）
}

interface GroupWithChildren extends Group {
    children: GroupWithChildren[];  // 子分组列表
}
```

#### 业务规则
- 分组名称在同一父级下必须唯一
- 支持无限层级的树形结构
- 删除父分组时需要在应用层级联删除所有子分组
- 颜色支持10种预定义颜色
- 根分组parent_id为NULL

#### 数据示例
```json
{
    "id": 1,
    "name": "社交媒体",
    "parent_id": null,
    "color": "blue",
    "created_at": "2024-01-01T10:00:00.000Z",
    "updated_at": "2024-01-01T10:00:00.000Z"
}
```

### 2.2 密码条目模型 (PasswordItem)

#### 数据表结构
```sql
CREATE TABLE passwords (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    title TEXT NOT NULL,
    username TEXT NOT NULL,
    password TEXT NOT NULL,
    url TEXT,
    notes TEXT,
    multi_accounts TEXT,
    group_id INTEGER NOT NULL,
    created_at TEXT NOT NULL,
    updated_at TEXT NOT NULL
);
```

#### 接口定义
```typescript
interface PasswordItem {
    id?: number;           // 密码ID（主键）
    title: string;         // 网站名称/应用名称（必填）
    username: string;      // 用户名/邮箱（必填）
    password: string;      // 密码（必填，加密存储）
    url?: string;          // 网址（可选）
    notes?: string;        // 备注（可选）
    multi_accounts?: string; // 多账号密码信息，纯文本格式，加密存储
    group_id?: number;     // 所属分组ID（必填）
    created_at?: string;   // 创建时间（ISO 8601格式）
    updated_at?: string;   // 更新时间（ISO 8601格式）
}

### 2.2.3 多账号密码文本格式
多账号密码信息采用纯文本格式，支持灵活的记录方式：

```
安装器
http://10.180.21.37:8080/login/#/login
账号 admin，密码 G52r9!F@D#fw

MySQL
10.180.21.44:3306
root 密码 %2Ld5%Hn3F
oper_dc 密码 eP^ivE7r7$
```

**格式说明：**
- 支持自由格式文本记录
- 每行可包含系统名称、地址、账号、密码等信息
- 使用空格或逗号分隔账号和密码
- 支持换行分隔不同的系统或服务
- 整体内容加密存储
```

#### 业务规则
- title和username、分组为必填字段
- password字段在数据库中加密存储
- multi_accounts字段存储自由格式的多账号文本信息，整体加密存储
- 删除分组时，需要在应用层将该分组下的密码条目的group_id设为NULL或删除
- 密码条目更新时，支持分组变更
- 支持全文搜索（title、username、url、notes、multi_accounts）
- 自动维护创建时间和更新时间
- 支持分页查询，默认10条一页，支持自定义分页参数
- 多账号信息支持导入导出，格式为自由文本

#### 数据示例
```json
{
    "id": 1,
    "title": "Google",
    "username": "user@gmail.com",
    "password": "encrypted_password_data",
    "url": "https://accounts.google.com",
    "notes": "主要邮箱账户",
    "multi_accounts": "安装器\nhttp://10.180.21.37:8080/login/#/login\n账号 admin，密码 xxx\n\nMySQL\n10.180.21.44:3306\nroot 密码 xxx\noper_dc 密码 xxx",
    "group_id": 1,
    "created_at": "2024-01-01T10:00:00.000Z",
    "updated_at": "2024-01-15T15:30:00.000Z"
}
```

#### 多账号数据示例
```
安装器
http://10.180.21.37:8080/login/#/login
账号 admin，密码 G52r9!F@D#fw

MySQL
10.180.21.44:3306
root 密码 %2Ld5%Hn3F
oper_dc 密码 eP^ivE7r7$

Redis
10.180.21.45:6379
default 密码 R3d1s#P@ss
```

### 2.3 密码历史模型 (PasswordHistory)

#### 数据表结构
```sql
CREATE TABLE password_history (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    password_id INTEGER NOT NULL,
    old_password TEXT NOT NULL,
    new_password TEXT NOT NULL,
    changed_at TEXT NOT NULL,
    changed_reason TEXT
);
```

#### 接口定义
```typescript
interface PasswordHistory {
    id?: number;           // 历史记录ID（主键）
    password_id: number;   // 关联的密码ID（外键）
    old_password: string;  // 旧密码（加密存储）
    new_password: string;  // 新密码（加密存储）
    changed_at: string;    // 修改时间（ISO 8601格式）
    changed_reason?: string; // 修改原因（可选）
}
```

#### 业务规则
- 每次密码修改都会创建历史记录
- 密码字段在数据库中加密存储
- 删除密码条目时需要在应用层级联删除所有历史记录
- 支持查看密码修改历史和时间轴
- 提供隐私保护功能，默认隐藏密码
- 支持删除单条/多条密码历史记录
- 密码历史记录支持分页查询，默认10条一页，支持自定义分页参数

#### 数据示例
```json
{
    "id": 1,
    "password_id": 1,
    "old_password": "encrypted_old_password",
    "new_password": "encrypted_new_password",
    "changed_at": "2024-01-15T15:30:00.000Z",
    "changed_reason": "定期更新密码"
}
```

## 3. 数据关系设计

### 3.1 实体关系图 (ERD)
```
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│  user_settings  │     │     groups      │     │   passwords     │
├─────────────────┤     ├─────────────────┤     ├─────────────────┤
│ id (PK)         │     │ id (PK)         │─────│ id (PK)         │
│ key (UNIQUE)    │     │ name            │     │ title           │
│ value           │     │ parent_id       │     │ username        │
│ type            │     │ color           │     │ password        │
│ category        │     │ created_at      │     │ url             │
│ description     │     │ updated_at      │     │ notes           │
│ created_at      │     └─────────────────┘     │ group_id        │
│ updated_at      │                               │ created_at      │
└─────────────────┘                               │ updated_at      │
                                                 └─────────────────┘
                                                        │
                                                        │
┌─────────────────┐                                     │
│ password_history│─────────────────────────────────────┘
├─────────────────┤
│ id (PK)         │
│ password_id     │
│ old_password    │
│ new_password    │
│ changed_at      │
│ changed_reason  │
└─────────────────┘
```

### 3.2 关系说明
- **user_settings**：独立表，存储用户配置信息
- **groups → groups**：自关联，支持树形结构（应用层维护）
- **groups → passwords**：一对多关系，一个分组可包含多个密码（应用层维护）
- **passwords → password_history**：一对多关系，一个密码可有多个历史记录（应用层维护）

### 3.3 级联操作
- 删除分组时需要在应用层级联删除子分组
- 删除分组时需要在应用层将密码的group_id设为NULL
- 删除密码时需要在应用层级联删除所有历史记录

## 4. 数据加密设计

### 4.1 加密策略
- **算法**：AES-256-CBC
- **密钥长度**：256位
- **IV长度**：128位（随机生成）
- **编码方式**：Base64

### 4.2 加密实现
```typescript
// 加密过程
private encrypt(text: string): string {
    const iv = crypto.randomBytes(16);
    const cipher = crypto.createCipher('aes-256-cbc', this.encryptionKey);
    let encrypted = cipher.update(text, 'utf8', 'hex');
    encrypted += cipher.final('hex');
    return iv.toString('hex') + ':' + encrypted;
}

// 解密过程
private decrypt(encryptedText: string): string {
    const parts = encryptedText.split(':');
    if (parts.length !== 2) {
        return encryptedText; // 未加密文本
    }
    const iv = Buffer.from(parts[0], 'hex');
    const encrypted = parts[1];
    const decipher = crypto.createDecipher('aes-256-cbc', this.encryptionKey);
    let decrypted = decipher.update(encrypted, 'hex', 'utf8');
    decrypted += decipher.final('utf8');
    return decrypted;
}
```

### 4.3 加密范围
- **必须加密**：passwords.password、password_history.old_password、password_history.new_password、passwords.multi_accounts
- **可选加密**：passwords.url、passwords.notes
- **不加密**：所有ID、时间戳、分组名称等元数据

### 4.4 密钥管理
- 密钥从环境变量或安全存储获取
- 支持密钥轮换机制
- 密钥不在应用中硬编码

## 5. 数据库索引设计

### 5.1 主键索引
```sql
-- 自动创建的主键索引
CREATE UNIQUE INDEX sqlite_autoindex_groups_1 ON groups(id);
CREATE UNIQUE INDEX sqlite_autoindex_passwords_1 ON passwords(id);
CREATE UNIQUE INDEX sqlite_autoindex_password_history_1 ON password_history(id);
```

### 5.2 业务索引
```sql
-- 关联字段索引，提高查询性能
CREATE INDEX idx_groups_parent_id ON groups(parent_id);
CREATE INDEX idx_passwords_group_id ON passwords(group_id);
CREATE INDEX idx_password_history_password_id ON password_history(password_id);

-- 用户设置索引
CREATE UNIQUE INDEX idx_user_settings_key ON user_settings(key);
CREATE INDEX idx_user_settings_category ON user_settings(category);
```

### 5.3 搜索索引
```sql
-- 全文搜索索引（SQLite FTS5）
CREATE VIRTUAL TABLE passwords_fts USING fts5(
    title, 
    username, 
    url, 
    notes,
    content='passwords'
);

-- 时间索引，支持按时间排序
CREATE INDEX idx_passwords_updated_at ON passwords(updated_at DESC);
CREATE INDEX idx_passwords_created_at ON passwords(created_at DESC);
```

### 5.4 唯一性索引
```sql
-- 分组名称唯一性约束（同一父级下）
CREATE UNIQUE INDEX idx_groups_name_parent ON groups(name, parent_id);
```

## 6. 数据操作接口

### 6.1 用户设置操作接口

#### 查询操作
```typescript
// 获取所有设置
public getAllSettings(): UserSetting[];

// 根据分类获取设置
public getSettingsByCategory(category: string): UserSetting[];

// 根据键名获取设置
public getSettingByKey(key: string): UserSetting | undefined;

// 获取设置值（带类型转换）
public getSettingValue<T = string>(key: string, defaultValue?: T): T;

// 获取所有设置分类
public getSettingCategories(): string[];
```

#### 修改操作
```typescript
// 保存设置（创建或更新）
public saveSetting(setting: UserSetting): number;

// 批量保存设置
public saveSettings(settings: UserSetting[]): number[];

// 根据键名更新设置值
public updateSettingValue(key: string, value: string): boolean;

// 删除设置
public deleteSetting(key: string): boolean;

// 重置设置为默认值
public resetSettingToDefault(key: string): boolean;

// 重置所有设置为默认值
public resetAllSettingsToDefault(): number;
```

#### 初始化操作
```typescript
// 初始化默认设置
public initializeDefaultSettings(): number;

// 导入设置
public importSettings(settings: UserSetting[]): number;

// 导出设置
public exportSettings(categories?: string[]): UserSetting[];
```

### 6.2 分组操作接口

#### 查询操作
```typescript
// 获取所有分组
public getGroups(): Group[];

// 获取树形结构分组
public getGroupWithChildren(parentId?: number): GroupWithChildren[];

// 根据ID获取分组
public getGroupById(id: number): Group | undefined;

// 根据名称获取分组
public getGroupByName(name: string, parentId?: number): Group | undefined;
```

#### 修改操作
```typescript
// 保存分组（创建或更新）
public saveGroup(group: Group): number;

// 删除分组
public deleteGroup(id: number): void;
```

### 6.3 密码操作接口

#### 查询操作
```typescript
// 获取所有密码
public getPasswords(): PasswordItem[];

// 根据分组ID获取密码
public getPasswordsByGroup(groupId: number): PasswordItem[];

// 搜索密码
public searchPasswords(query: string): PasswordItem[];

// 根据ID获取密码
public getPasswordById(id: number): PasswordItem | undefined;

// 获取密码的多账号信息
public getPasswordMultiAccounts(id: number): string;

// 设置密码的多账号信息
public setPasswordMultiAccounts(id: number, accounts: string): void;
```

#### 修改操作
```typescript
// 保存密码（创建或更新）
public savePassword(password: PasswordItem): number;

// 删除密码
public deletePassword(id: number): void;

// 更新密码（记录历史）
public updatePassword(id: number, newPassword: string, reason?: string): void;
```

### 6.4 历史记录操作接口

#### 查询操作
```typescript
// 获取密码历史
public getPasswordHistory(passwordId: number): PasswordHistory[];

// 根据ID获取历史记录
public getHistoryById(id: number): PasswordHistory | undefined;
```

#### 修改操作
```typescript
// 添加历史记录
public addPasswordHistory(history: PasswordHistory): number;

// 删除历史记录
public deleteHistory(id: number): void;

// 清理旧历史记录
public cleanOldHistory(daysToKeep: number = 365): number;
```

## 7. 数据完整性约束

### 7.1 实体完整性
- 主键自动生成，唯一且非空
- 必填字段非空约束
- 外键引用完整性

### 7.2 域完整性
- 时间戳格式验证（ISO 8601）
- 密码强度验证
- URL格式验证
- 分组名称长度限制

### 7.3 参照完整性
- 应用层外键约束检查
- 应用层级联删除规则
- 应用层级联更新规则

### 7.4 用户定义完整性
- 分组名称唯一性
- 密码历史记录完整性
- 数据加密一致性

## 8. 性能优化策略

### 8.1 查询优化
- 合理使用索引
- 预编译SQL语句
- 分页查询大数据集
- 缓存常用查询结果

### 8.2 存储优化
- 数据压缩存储
- 定期清理历史数据
- 数据库文件维护
- WAL模式提高并发性能

### 8.3 加密优化
- 批量加密/解密操作
- 内存中敏感数据及时清理
- 加密算法性能调优
- 密钥缓存机制

## 9. 数据迁移设计

### 9.1 版本控制
```sql
CREATE TABLE schema_version (
    version INTEGER PRIMARY KEY,
    applied_at TEXT NOT NULL,
    description TEXT
);
```

### 9.2 迁移脚本
- 支持数据库版本升级
- 数据格式转换
- 向后兼容性保证
- 回滚机制

### 9.3 数据导入导出

#### 支持格式
- **JSON格式**：完整数据结构，支持所有字段和关系
- **CSV格式**：表格格式，支持Excel兼容，仅支持密码条目数据
- **加密压缩包**：所有格式都支持AES-256加密和ZIP压缩

#### 导出功能
```typescript
interface ExportOptions {
    format: 'json' | 'csv' | 'encrypted_zip';
    includeHistory: boolean;
    includeGroups: boolean;
    includeSettings: boolean;
    passwordStrength: 'weak' | 'medium' | 'strong';
    compressionLevel: number; // 0-9
}

// 导出接口
public exportData(options: ExportOptions): Promise<Uint8Array>;
```

#### 导入功能
```typescript
interface ImportOptions {
    format: 'json' | 'csv';
    mergeStrategy: 'replace' | 'merge' | 'skip';
    validateIntegrity: boolean;
    dryRun: boolean;
}

// 导入接口
public importData(data: Uint8Array, options: ImportOptions): Promise<ImportResult>;
```

#### JSON格式示例
```json
{
    "version": "1.0",
    "exported_at": "2024-01-01T10:00:00.000Z",
    "user_settings": [
        {
            "key": "security.auto_lock_timeout",
            "value": "300",
            "type": "number",
            "category": "security",
            "description": "自动锁定时间（秒）",
            "created_at": "2024-01-01T10:00:00.000Z",
            "updated_at": "2024-01-01T10:00:00.000Z"
        }
    ],
    "groups": [
        {
            "id": 1,
            "name": "社交媒体",
            "parent_id": null,
            "color": "blue",
            "created_at": "2024-01-01T10:00:00.000Z",
            "updated_at": "2024-01-01T10:00:00.000Z"
        }
    ],
    "passwords": [
        {
            "id": 1,
            "title": "Google",
            "username": "user@gmail.com",
            "password": "encrypted_password_data",
            "url": "https://accounts.google.com",
            "notes": "主要邮箱账户",
            "multi_accounts": "安装器\nhttp://10.180.21.37:8080/login/#/login\n账号 admin，密码 G52r9!F@D#fw\n\nMySQL\n10.180.21.44:3306\nroot 密码 %2Ld5%Hn3F\noper_dc 密码 eP^ivE7r7$",
            "group_id": 1,
            "created_at": "2024-01-01T10:00:00.000Z",
            "updated_at": "2024-01-15T15:30:00.000Z"
        }
    ],
    "password_history": [
        {
            "id": 1,
            "password_id": 1,
            "old_password": "encrypted_old_password",
            "new_password": "encrypted_new_password",
            "changed_at": "2024-01-15T15:30:00.000Z",
            "changed_reason": "定期更新密码"
        }
    ]
}
```

#### CSV格式示例
```csv
title,username,password,url,notes,group_name,created_at,updated_at
Google,user@gmail.com,encrypted_password,https://accounts.google.com,主要邮箱账户,社交媒体,2024-01-01T10:00:00.000Z,2024-01-15T15:30:00.000Z
GitHub,developer,encrypted_password,https://github.com,代码托管,开发工具,2024-01-02T11:00:00.000Z,2024-01-16T16:00:00.000Z
```

#### 加密压缩实现
```typescript
// 加密压缩导出
private async encryptAndCompress(data: string, password: string): Promise<Uint8Array> {
    // 1. 压缩数据
    const compressed = await gzip(data);
    
    // 2. 加密压缩数据
    const encrypted = this.encrypt(compressed.toString('base64'), password);
    
    // 3. 创建ZIP文件结构
    const zip = new JSZip();
    zip.file('passwords.encrypted', encrypted);
    zip.file('metadata.json', JSON.stringify({
        version: '1.0',
        created_at: new Date().toISOString(),
        compression: 'gzip',
        encryption: 'aes-256-cbc'
    }));
    
    return await zip.generateAsync({type: 'uint8array'});
}

// 解密解压导入
private async decryptAndDecompress(zipData: Uint8Array, password: string): Promise<string> {
    // 1. 解压ZIP文件
    const zip = await JSZip.loadAsync(zipData);
    const encryptedFile = zip.file('passwords.encrypted');
    const encrypted = await encryptedFile.async('string');
    
    // 2. 解密数据
    const compressedBase64 = this.decrypt(encrypted, password);
    
    // 3. 解压数据
    const compressed = Buffer.from(compressedBase64, 'base64');
    const decompressed = await gunzip(compressed);
    
    return decompressed.toString();
}
```

#### 数据完整性验证
```typescript
interface ValidationResult {
    isValid: boolean;
    errors: string[];
    warnings: string[];
    statistics: {
        settings: number;
        groups: number;
        passwords: number;
        historyRecords: number;
    };
}

// 验证导入数据
public validateImportData(data: any): ValidationResult {
    const result: ValidationResult = {
        isValid: true,
        errors: [],
        warnings: [],
        statistics: { groups: 0, passwords: 0, historyRecords: 0 }
    };
    
    // 验证数据结构
    if (!data.version) {
        result.isValid = false;
        result.errors.push('缺少版本信息');
    }
    
    // 验证用户设置
    if (data.user_settings) {
        data.user_settings.forEach((setting: any, index: number) => {
            if (!setting.key || !setting.value) {
                result.isValid = false;
                result.errors.push(`用户设置 ${index + 1} 缺少必需字段`);
            }
        });
        result.statistics.settings = data.user_settings.length;
    }
    
    // 验证必需字段
    if (data.passwords) {
        data.passwords.forEach((pwd: any, index: number) => {
            if (!pwd.title || !pwd.username) {
                result.isValid = false;
                result.errors.push(`密码条目 ${index + 1} 缺少必需字段`);
            }
        });
        result.statistics.passwords = data.passwords.length;
    }
    
    return result;
}
```

## 10. 备份与恢复

### 10.1 备份策略
- 定期自动备份
- 手动备份触发
- 增量备份机制
- 备份文件加密

### 10.2 恢复机制
- 完整恢复
- 选择性恢复
- 数据验证
- 冲突处理

### 10.3 数据同步
- 本地文件同步
- 云盘备份支持
- 跨设备数据迁移
- 数据合并策略

## 11. 安全考虑

### 11.1 数据保护
- 传输加密
- 存储加密
- 内存保护
- 日志脱敏

### 11.2 访问控制
- 主密码验证
- 会话管理
- 自动锁定
- 权限控制

### 11.3 审计日志
- 操作记录
- 访问日志
- 异常监控
- 安全事件

## 12. 数据模型验证

### 12.1 单元测试
- 数据库操作测试
- 加密解密测试
- 约束验证测试
- 性能基准测试

### 12.2 集成测试
- 端到端数据流测试
- 并发操作测试
- 大数据量测试
- 故障恢复测试

### 12.3 安全测试
- 加密强度测试
- 数据泄露测试
- 权限绕过测试
- 恶意输入测试

---

## 文档信息

- **文档版本**：v1.0
- **创建日期**：2024年11月19日
- **最后更新**：2024年11月19日
- **技术栈**：SQLite + TypeScript + Electron
- **数据库版本**：SQLite 3.40+
- **加密标准**：AES-256-CBC

## 附录

### A. 数据库初始化脚本
```sql
-- 数据库初始化脚本包含在DatabaseService.ts中
-- 自动创建表结构、索引和触发器
```

### B. 数据字典
详细的字段说明、数据类型、约束条件和业务规则定义。

### C. API接口文档
完整的数据库操作接口说明，包括参数、返回值和异常处理。

### D. 性能基准
各种操作的性能基准测试结果和优化建议。